var __reflect=this&&this.__reflect||function(t,e,r){t.__class__=e,r?r.push(e):r=[e],t.__types__=t.__types__?r.concat(t.__types__):r},__extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);r.prototype=e.prototype,t.prototype=new r},__awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(o,n){function s(t){try{h(i.next(t))}catch(e){n(e)}}function a(t){try{h(i["throw"](t))}catch(e){n(e)}}function h(t){t.done?o(t.value):new r(function(e){e(t.value)}).then(s,a)}h((i=i.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function r(t){return function(e){return i([t,e])}}function i(r){if(o)throw new TypeError("Generator is already executing.");for(;h;)try{if(o=1,n&&(s=n[2&r[0]?"return":r[0]?"throw":"next"])&&!(s=s.call(n,r[1])).done)return s;switch(n=0,s&&(r=[0,s.value]),r[0]){case 0:case 1:s=r;break;case 4:return h.label++,{value:r[1],done:!1};case 5:h.label++,n=r[1],r=[0];continue;case 7:r=h.ops.pop(),h.trys.pop();continue;default:if(s=h.trys,!(s=s.length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){h=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){h.label=r[1];break}if(6===r[0]&&h.label<s[1]){h.label=s[1],s=r;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(r);break}s[2]&&h.ops.pop(),h.trys.pop();continue}r=e.call(t,h)}catch(i){r=[6,i],n=0}finally{o=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var o,n,s,a,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:r(0),"throw":r(1),"return":r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,r){function i(i){e.call(r,i,t)}if(RES.hasRes(t)){var o=RES.getRes(t);o?i(o):RES.getResAsync(t,i,this)}else RES.getResByUrl(t,i,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.dc=new Dc,e.maxAngry=10,e.angry=0,e}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var e=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",e),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e,r;return __generator(this,function(i){switch(i.label){case 0:return[4,this.loadResource()];case 1:return i.sent(),this.createGameScene(),t=this,[4,RES.getResAsync("description_json")];case 2:return t.result=i.sent(),e=this,[4,RES.getResAsync("sorrytxt_json")];case 3:return e.sorryTxt=i.sent(),this.startAnimation(this.result),[4,platform.login()];case 4:return i.sent(),[4,platform.getUserInfo()];case 5:return r=i.sent(),console.log(r),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return r.sent(),[4,this.loadTheme()];case 2:return r.sent(),[4,RES.loadGroup("preload",0,t)];case 3:return r.sent(),this.stage.removeChild(t),[3,5];case 4:return e=r.sent(),console.error(e),[3,5];case 5:return[2]}})})},e.prototype.loadTheme=function(){var t=this;return new Promise(function(e,r){var i=new eui.Theme("resource/default.thm.json",t.stage);i.addEventListener(eui.UIEvent.COMPLETE,function(){e()},t)})},e.prototype.createGameScene=function(){var t=this.createBitmapByName("bg_jpg");this.addChild(t);var e=this.stage.stageWidth,r=this.stage.stageHeight;t.width=e,t.height=r;var i=new egret.Shape;i.graphics.beginFill(0,.5),i.graphics.drawRect(0,0,e,172),i.graphics.endFill(),i.y=33,this.addChild(i);var o=this.createBitmapByName("logo_png");this.addChild(o),o.width=150,o.height=130,o.x=10,o.y=55;var n=new egret.Shape;n.graphics.lineStyle(2,16777215),n.graphics.moveTo(0,0),n.graphics.lineTo(0,117),n.graphics.endFill(),n.x=172,n.y=61,this.addChild(n);var s=new egret.TextField;s.textColor=16777215,s.width=e-172,s.textAlign="center",s.text="抽卡模拟器 V1.0",s.size=24,s.x=172,s.y=80,this.addChild(s),this.reportGrp=new eui.Group,this.reportGrp.includeInLayout=!0,this.reportLabel=new egret.TextField,this.reportLabel.textColor=16777215,this.reportLabel.textAlign="center",this.reportLabel.x=100,this.reportLabel.size=35,this.reportGrp.addChild(this.reportLabel),this.reportSc=new eui.Scroller,this.reportSc.bounces=!0,this.reportSc.touchEnabled=!0,this.reportSc.viewport=this.reportGrp,this.reportSc.viewport.scrollV=0,this.reportSc.width=e,this.reportSc.height=r-200,this.reportSc.y=205,this.reportSc.height=750,this.reportSc.addChild(this.reportGrp),this.addChild(this.reportSc);var a=new egret.TextField;this.addChild(a),a.alpha=0,a.width=e-172,a.textAlign=egret.HorizontalAlign.CENTER,a.size=24,a.textColor=16777215,a.x=172,a.y=135,this.textfield=a;var h=new eui.Button;h.label="Draw",h.horizontalCenter=95,h.verticalCenter=495,this.addChild(h),h.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onDcDrawCard,this);var l=new eui.Button;l.label="Reset",l.horizontalCenter=195,l.verticalCenter=495,this.addChild(l),l.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onDcReset,this),this.tf=new egret.TextField,this.tf.type=egret.TextFieldType.INPUT,this.tf.background=!0,this.tf.backgroundColor=11584734,this.tf.textColor=16777215,this.tf.multiline=!0,this.tf.width=220,this.tf.height=50,this.tf.text="点击输入连抽次数",this.tf.textAlign=egret.HorizontalAlign.CENTER,this.tf.verticalAlign=egret.VerticalAlign.MIDDLE,this.tf.size=23,this.tf.x=80,this.tf.y=1037,this.addChild(this.tf),this.tf.addEventListener(egret.Event.FOCUS_IN,this.onfocusIn,this),this.tf.addEventListener(egret.Event.FOCUS_OUT,this.onfocusOut,this),this.dc.initCfg()},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,r=RES.getRes(t);return e.texture=r,e},e.prototype.startAnimation=function(t){var e=this;this.parser=new egret.HtmlTextParser,this.textflowArr=t.map(function(t){return e.parser.parse(t)});var r=this.textfield,i=-1,o=function(){i++,i>=e.textflowArr.length&&(i=0);var t=e.textflowArr[i];r.textFlow=t;var n=egret.Tween.get(r);n.to({alpha:1},200),n.wait(2e3),n.to({alpha:0},200),n.call(o,e)};o()},e.prototype.showlogs=function(){this.reportLabel.height>this.reportSc.height&&(this.reportSc.viewport.scrollV=this.reportLabel.height-this.reportSc.height/2),this.reportLabel.text=CardFsm.getInstance().logs},e.prototype.onDcDrawCard=function(t){this.dc.drawCard(),this.showlogs()},e.prototype.onDcReset=function(t){this.dc.OnReset(),this.showlogs()},e.prototype.onfocusIn=function(t){t.target.text=""},e.prototype.onfocusOut=function(t){var e=this,r=/^[\u4e00-\u9fa5_a-zA-Z]+$/;if(this.angry<this.maxAngry)this.dc.serialDraw(t.target.text),""==t.target.text?t.target.text="点击输入连抽次数":r.test(t.target.text)?(this.angry++,this.angry<5?t.target.text="请勿输入无效内容":this.angry<6?t.target.text="别填乱七八糟的东西啊，混蛋！":this.angry<7?t.target.text="WDNMD！你还真继续乱填啊？":this.angry<8?t.target.text="没完了是吧？":this.angry<9?t.target.text="秋梨膏，再乱搞我就要崩溃了":this.angry<10?t.target.text="？？？？？":this.angry>=this.maxAngry&&this.banSerialDraw(t)):t.target.text="开始"+t.target.text+"连抽";else if("sorry"==t.target.text||"对不起"==t.target.text){this.angry=0;var i=[];this.textflowArr=[],i.push(this.result.map(function(t){return e.parser.parse(t)})),this.textflowArr=i[0],t.target.backgroundColor=11584734,t.target.text="好吧，下不为例！"}else t.target.text="输入框已被禁用";this.showlogs()},e.prototype.banSerialDraw=function(t){var e=this,r=[];this.textflowArr=[],r.push(this.sorryTxt.map(function(t){return e.parser.parse(t)})),this.textflowArr=r[0],t.target.text="输入框已被禁用",t.target.backgroundColor=14423100},e}(eui.UILayer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,r,i){function o(t){e.call(i,t)}function n(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,n,null),r.call(i))}var s=this;if("undefined"!=typeof generateEUI)egret.callLater(function(){e.call(i,generateEUI)},this);else if("undefined"!=typeof generateEUI2)RES.getResByUrl("resource/gameEui.json",function(t,r){window.JSONParseClass.setData(t),egret.callLater(function(){e.call(i,generateEUI2)},s)},this,RES.ResourceItem.TYPE_JSON);else if("undefined"!=typeof generateJSON)if(t.indexOf(".exml")>-1){var a=t.split("/");a.pop();var h=a.join("/")+"_EUI.json";generateJSON.paths[t]?egret.callLater(function(){e.call(i,generateJSON.paths[t])},this):RES.getResByUrl(h,function(r){window.JSONParseClass.setData(r),egret.callLater(function(){e.call(i,generateJSON.paths[t])},s)},this,RES.ResourceItem.TYPE_JSON)}else egret.callLater(function(){e.call(i,generateJSON)},this);else RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,n,null),RES.getResByUrl(t,o,this,RES.ResourceItem.TYPE_TEXT)},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var CardFsm=function(){function t(){this._userCards=[],this._logs=""}return Object.defineProperty(t.prototype,"userCards",{get:function(){return this._userCards},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logs",{get:function(){return this._logs},enumerable:!0,configurable:!0}),t.prototype.setlogs=function(t){this._logs+="\n"+t},t.getInstance=function(){return null==this.CardFsm&&(this.CardFsm=new t),this.CardFsm},t.prototype.clearUserCard=function(){this._userCards=[]},t.prototype.addUserCards=function(t){if(0==this._userCards.length)this._userCards=t;else{for(var e=function(e){t.forEach(function(t,r,i){t.type==e.type&&(e.count++,i.splice(r,1))})},r=0,i=this._userCards;r<i.length;r++){var o=i[r];e(o)}for(var n=0,s=t;n<s.length;n++)for(var a=s[n],h=0,l=this._userCards;h<l.length;h++){var o=l[h];o.type!=a.type&&this._userCards.push(a)}}this.setUnique(this._userCards)},t.prototype.setUnique=function(t){for(var e=0;e<t.length;e++)for(var r=e+1;r<t.length;r++)t[e]==t[r]&&(t.splice(r,1),r--);return t},t}();__reflect(CardFsm.prototype,"CardFsm");var Dc=function(){function t(){this.RANDNUM=0,this.DRAWNUM=0,this.OFFSET=0,this.resCardPool=[],this.curCardPool=[],this.selectPR=1,this.doormat=[]}return t.prototype.initCfg=function(){t._CFG_=RES.getRes("dcconfig_json"),t._CARDS_=t._CFG_.cards,this.MAINTYPES=this.CURTYPES=t._CFG_.mainpool_type,this.initCardFsm()},t.prototype.resetCurPool=function(){this.CURTYPES=this.MAINTYPES,this.curCardPool=[],this.selectCard=null},t.prototype.initCardFsm=function(){var t=[];this.loadCfgToPool(t,this.MAINTYPES),this.getInstancePool(t),CardFsm.getInstance().clearUserCard(),CardFsm.getInstance().addUserCards(t)},t.prototype.findCfgByType=function(e){for(var r=0;r<t._CARDS_.length;r++)if(t._CARDS_[r].type===e)return t._CARDS_[r];throw Error("缺少卡牌"+e+"的配置！")},t.prototype.loadCfgToPool=function(t,e){for(var r=0;r<e.length;r++){var i=this.findCfgByType(e[r]);t.push(i)}return t},t.prototype.getInstancePool=function(t){for(var e=0,r=t;e<r.length;e++){var i=r[e],o=new StdCard(i.type,i.awardPool,i.PR,i.PR_Offset,i.isRare),n=t.indexOf(i);0==o.PR&&this.doormat.push(o),n>-1&&t.splice(n,1,o)}return t},t.prototype.loadSecByCfg=function(t){return t&&(this.CURTYPES=t.awardPool),this.curCardPool=[],this.loadCfgToPool(this.curCardPool,this.CURTYPES),this.getInstancePool(this.curCardPool)},t.prototype.createCard=function(){this.loadSecByCfg(this.selectCard),this.distributePR(this.curCardPool)},t.prototype.drawCard=function(t){this.createCard(),this.RANDNUM=Math.random();for(var e=0,r=this.curCardPool;e<r.length;e++){var i=r[e],o=i.PR_Line+i.PR_Offset*this.OFFSET;if(this.RANDNUM<=o){if(i.count++,this.loadInResPool(this.curCardPool),this.selectCard=i,this.selectPR=this.selectPR*i.PR,this.OFFSET=i.isRare?0:this.OFFSET+1,0==i.awardPool.length){if(this.DRAWNUM++,this.recordFsm(),!t){var n="【"+this.DRAWNUM+"】抽中卡片: "+this.selectCard.type+"\n抽中名义概率:"+(100*this.selectPR).toFixed(2)+"%";egret.log("【"+this.DRAWNUM+"】抽中卡片:"+this.selectCard.type),egret.log("抽中名义概率:"+(100*this.selectPR).toFixed(2)+"%"),CardFsm.getInstance().setlogs(n),this.showCard()}return this.resetCurPool(),void(this.selectPR=1)}return this.drawCard(t)}}},t.prototype.distributePR=function(t){var e=this;if(!this.doormat)throw Error("卡池中所有卡牌均为手动配置概率，可能会导致计算错误，请至少有一个自动分配");var r=0;if(this.doormat.length==t.length){for(var i=0,o=t;i<o.length;i++){var n=o[i];n.PR=1/t.length,r+=n.PR,n.PR_Line=r}return void(this.doormat=[])}if(1==this.doormat.length){for(var s=0,a=t;s<a.length;s++){var n=a[s];if(n.type===this.doormat[0].type){if(!(1>r))throw Error("卡池中分配的基础概率超过100%");this.doormat[0].PR=1-r,this.doormat[0].PR_Line=1}else r+=n.PR,n.PR_Line=r}return void(this.doormat=[])}if(this.doormat.length>1){for(var h=t.filter(function(t){return!~e.doormat.indexOf(t)}),l=0,c=h;l<c.length;l++){var n=c[l];r+=n.PR,n.PR_Line=r}if(r>=1)throw Error("卡池中分配的基础概率超过100%");for(var u=(1-r)/this.doormat.length,d=0;d<this.doormat.length;d++)this.doormat[d].PR=u,r+=u,this.doormat[d].PR_Line=r;return void(this.doormat=[])}},t.prototype.loadInResPool=function(t){var e=this;return t.forEach(function(t,r,i){1==t.count&&e.resCardPool.push(t)}),this.resCardPool},t.prototype.serialDraw=function(t){var e=Math.floor(t);if(!(1>e)&&e){for(var r=0;e>r;r++)this.drawCard(!0);CardFsm.getInstance().setlogs("-----开始"+t+"连抽-----"),this.showCard(),this.OnReset()}},t.prototype.showCard=function(){for(var t=0,e=this.MAINTYPES;t<e.length;t++)for(var r=e[t],i=0,o=CardFsm.getInstance().userCards;i<o.length;i++){var n=o[i];if(n.type===r){var s=(n.count/this.DRAWNUM*100).toFixed(2),a=""+n.type+":"+n.count+"占比:"+s+"%";egret.log(n.type+":"+n.count,"占比:"+s+"%"),CardFsm.getInstance().setlogs(a)}}},t.prototype.recordFsm=function(){CardFsm.getInstance().addUserCards(this.resCardPool),this.resCardPool=[]},t.prototype.OnReset=function(){this.initCardFsm(),this.DRAWNUM=0,this.RANDNUM=0,this.OFFSET=0,this.selectPR=1,this.selectCard=null,this.curCardPool=[],this.resCardPool=[],egret.log("-----数据已清空-----"),CardFsm.getInstance().setlogs("-----数据已清空-----")},t}();__reflect(Dc.prototype,"Dc");var StdCard=function(){function t(t,e,r,i,o){this._count=0,this._PR_Offset=0,this._type=t,this._awardPool=e,this._PR=r,this._PR_Offset=i,this._isRare=o}return Object.defineProperty(t.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"count",{get:function(){return this._count},set:function(t){this._count=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"awardPool",{get:function(){return this._awardPool},set:function(t){this._awardPool=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PR",{get:function(){return this._PR},set:function(t){this._PR=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PR_Line",{get:function(){return this._PR_Line},set:function(t){this._PR_Line=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"PR_Offset",{get:function(){return this._PR_Offset},set:function(t){this._PR_Offset=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRare",{get:function(){return this._isRare},set:function(t){this._isRare=t},enumerable:!0,configurable:!0}),t}();__reflect(StdCard.prototype,"StdCard");